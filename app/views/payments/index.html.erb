<% if @invoice.start_date != nil and @invoice.end_date != nil %>
    <h1>Payments for Invoice <%= @invoice.start_date.strftime("%m-%d-%Y") %> - <%= @invoice.end_date.strftime("%m-%d-%Y") %></h1>
<% elsif @invoice.start_date != nil and @invoice.end_date == nil %>
    <h1>Payments for Invoice Starting <%= @invoice.start_date.strftime("%m-%d-%Y") %></h1>
<% elsif @invoice.start_date == nil and @invoice.end_date != nil %>
    <h1>Payments for Invoice Ending <%= @invoice.end_date.strftime("%m-%d-%Y") %></h1>
<% else %>
    <h1>Payments</h1>
<% end %>

<%= link_to "Back to Invoices", user_invoices_path(@user), class: "btn btn-primary" %><br><br>

<% if @invoice.status == "Paid" %>
    <p class="emphasized"><strong>Status: <span class="approve"><%= @invoice.status %></span></strong></p>
<% else %>
    <p class="emphasized"><strong>Status: <%= @invoice.status %></strong></p>
<% end %>

<% if @invoice.payments.count > 0 %>
    <table class="table table-striped">
      <% if current_user.master %>
          <col width="50"> <!-- ID for Masters -->
      <% end %>
      <col width="100"> <!-- Date -->
      <col width="200"> <!-- Description -->
      <col width="100"> <!-- Hours -->
      <col width="100"> <!-- Daily Rate -->
      <% if current_user.master %>
          <col width="200"> <!-- Created At for Masters -->
          <col width="200"> <!-- Updated At for Masters -->
      <% end %>
      <col width="50"> <!-- Edit Button -->
      <col width="50"> <!-- Delete Button -->
      <tr>
        <% if current_user.master %>
            <th>ID</th>
        <% end %>
        <th>Date</th>
        <th>Description</th>
        <th>Hours</th>
        <th>Daily Rate</th>
        <% if current_user.master %>
            <th>Created At</th>
            <th>Updated At</th>
        <% end %>
        <th></th>
        <th></th>
      </tr>
      <%= render @payments %>
      <tr>
        <% if current_user.master %>
            <td class="middle-align right-align" colspan="3"><strong>Total:</strong></td>
        <% else %>
            <td class="middle-align right-align" colspan="2"><strong>Total:</strong></td>
        <% end %>

        <% if @invoice.hours == nil %>
            <td class="middle-align"><strong><%= sprintf('%.2f', @invoice.payments.sum(:hours)) %></strong></td>
        <% else %>
            <td class="override middle-align"><strong><%= sprintf('%.2f', @invoice.hours) %></strong></td>
        <% end %>

        <% if current_user.master %>
            <td colspan="2"></td>
        <% end %>

        <% if @invoice.net_pay == nil %>
            <% if @invoice.rate == nil %>
                <% if @invoice.hours == nil %>
                    <!-- No overrides -->
                    <td class="center emphasized" colspan="3"><strong>$
                      <%= sprintf('%.2f', @invoice.payments.where(:daily_rate => nil).sum(:hours) * @invoice.user.rate + @invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
                    </strong></td>
                <% else %>
                    <!-- Hours override -->
                    <td class="center emphasized" colspan="3"><strong>$
                      <%= sprintf('%.2f', @invoice.hours * @invoice.user.rate + @invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
                    </strong></td>
                <% end %>
            <% else %>
                <% if @invoice.hours == nil %>
                    <!-- Rate override -->
                    <td class="center emphasized" colspan="3"><strong>$
                      <%= sprintf('%.2f', @invoice.payments.where(:daily_rate => nil).sum(:hours) * @invoice.rate + @invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
                    </strong></td>
                <% else %>
                    <!-- Rate and hours override -->
                    <td class="center emphasized" colspan="3"><strong>$
                      <%= sprintf('%.2f', @invoice.hours * @invoice.rate + @invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
                    </strong></td>
                <% end %>
            <% end %>
        <% else %>
            <!-- Net pay override -->
            <td class="override center emphasized" colspan="3"><strong>$
              <%= sprintf('%.2f', @invoice.net_pay) %>
            </strong></td>
        <% end %>
      </tr>
    </table>
    <table class="no-border">
      <col width="125">
      <col width="125">
      <tr>
        <% if @invoice.status == "Started" or @invoice.status == "In Progress" %>
            <td>
              <%= link_to "New Payment", new_invoice_payment_path(@invoice), class: "btn btn-success" %>
            </td>
        <% end %>
        <% if @invoice.status == "In Progress" %>
            <td>
              <%= link_to "Submit Invoice", edit_invoice_path(@invoice, :submit => true, :from_payments => true), class: "btn btn-success" %>
            </td>
        <% elsif @invoice.status == "Pending" %>
            <td>
              <%= link_to "Reset invoice", edit_invoice_path(@invoice, :reset => true, :from_payments => true), class: "btn btn-primary" %>
            </td>
        <% end %>
    </table><br>
<% else %>
    <p>There are no payments under this invoice yet.</p>
    <% if @invoice.status == "Started" or @invoice.status == "In Progress" %>
        <td>
          <%= link_to "New Payment", new_invoice_payment_path(@invoice), class: "btn btn-success" %>
        </td>
    <% end %>
<% end %>