<tr>
  <% if current_user.master %>
      <td class="middle-align"><%= invoice.id %></td>
  <% end %>
  <% if @all or @pending_only %>
      <td class="middle-align"><%= invoice.user.fullname %></td>
  <% end %>

  <% if invoice.start_date != nil and invoice.end_date != nil %>
      <td class="middle-align center">
        <%= invoice.start_date.strftime("%m/%d/%y") %> - <%= invoice.end_date.strftime("%m/%d/%y") %>
      </td>
  <% elsif invoice.start_date == nil and invoice.end_date != nil %>
      <td class="middle-align center">
        Ended <%= invoice.end_date.strftime("%m/%d/%y") %>
      </td>
  <% elsif invoice.start_date != nil and invoice.end_date == nil %>
      <td class="middle-align center">
        Started <%= invoice.start_date.strftime("%m/%d/%y") %>
      </td>
  <% else %>
      <td></td>
  <% end %>

  <% if invoice.hours == nil %>
      <td class="middle-align right-align"><%= sprintf('%.2f', invoice.payments.sum(:hours)) %></td>
  <% else %>
      <td class="override middle-align right-align"><%= sprintf('%.2f', invoice.hours) %></td>
  <% end %>

  <% if current_user.master %>
      <td class="middle-align right-align"><%= sprintf('%.2f', invoice.user.rate) %></td>
  <% end %>

  <% if invoice.net_pay == nil %>
      <% if invoice.rate == nil %>
          <% if invoice.hours == nil %>
            <!-- No overrides -->
            <td class="middle-align right-align">$
              <%= sprintf('%.2f', invoice.payments.where(:daily_rate => nil).sum(:hours) * invoice.user.rate + invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
            </td>
          <% else %>
            <!-- Hours override -->
            <td class="middle-align right-align">$
              <%= sprintf('%.2f', invoice.hours * invoice.user.rate + invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
            </td>
          <% end %>
      <% else %>
          <% if invoice.hours == nil %>
            <!-- Rate override -->
            <td class="middle-align right-align">$
              <%= sprintf('%.2f', invoice.payments.where(:daily_rate => nil).sum(:hours) * invoice.rate + invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
            </td>
          <% else %>
            <!-- Rate and hours override -->
            <td class="middle-align right-align">$
              <%= sprintf('%.2f', invoice.hours * invoice.rate + invoice.payments.where.not(:daily_rate => nil).sum(:daily_rate)) %>
            </td>
          <% end %>
      <% end %>
  <% else %>
      <!-- Net pay override -->
      <td class="override middle-align right-align">$ <%= sprintf('%.2f', invoice.net_pay) %></td>
  <% end %>

  <% if invoice.status == "Paid" %>
      <td class="approve middle-align center"><strong><%= invoice.status %></strong></td>
  <% else %>
      <td class="middle-align center"><%= invoice.status %></td>
  <% end %>

  <% if current_user.admin %>
      <td class="middle-align right-align"><%= invoice.check_no %></td>
  <% end %>

  <% if current_user.master %>
      <% if invoice.created_at %>
          <td class="middle-align"><%= invoice.created_at.to_time.to_datetime.to_s[0..9] + " " +
                                           invoice.created_at.to_time.to_datetime.to_s[11..18] %></td>
      <% else %>
          <td class="middle-align">nil</td>
      <% end %>
      <% if invoice.created_at %>
          <td class="middle-align"><%= invoice.updated_at.to_time.to_datetime.to_s[0..9] + " " +
                                           invoice.updated_at.to_time.to_datetime.to_s[11..18] %></td>
      <% else %>
          <td class="middle-align">nil</td>
      <% end %>
  <% end %>

  <% if current_user.admin == false %>
    <% if invoice.status == "Started" %>
        <td class="middle-align">
          <%= link_to "View Payments", invoice_payments_path(invoice), class: "btn btn-primary" %>
        </td>
        <td class="middle-align"></td>
        <td class="middle-align">
          <%= link_to "Edit", edit_invoice_path(invoice), class: "btn btn-primary"  %>
        </td>

        <td class="middle-align">
          <%= link_to "Delete", invoice_path(invoice), class: "btn btn-danger", method: :delete %>
        </td>
    <% elsif invoice.status == "In Progress" %>
        <td class="middle-align">
          <%= link_to "View Payments", invoice_payments_path(invoice), class: "btn btn-primary" %>
        </td>

        <td class="middle-align">
          <% if @user %>
            <%= link_to "Submit", edit_invoice_path(invoice, :submit => true), class: "btn btn-primary" %>
          <% else %>
            <%= link_to "Submit", edit_invoice_path(invoice, :submit => true, :from_pending => true), class: "btn btn-primary" %>
          <% end %>
        </td>

        <td class="middle-align">
          <%= link_to "Edit", edit_invoice_path(invoice), class: "btn btn-primary" %>
        </td>

        <td class="middle-align">
          <%= link_to "Delete", invoice_path(invoice), class: "btn btn-danger", method: :delete %>
        </td>
    <% elsif invoice.status == "Pending" %>
        <td class="middle-align">
          <%= link_to "View Invoice", invoice_payments_path(invoice), class: "btn btn-primary" %>
        </td>

        <td class="middle-align">
          <% if @user %>
              <%= link_to "Reset", edit_invoice_path(invoice, :reset => true), class: "btn btn-primary" %>
          <% else %>
              <%= link_to "Reset", edit_invoice_path(invoice, :reset => true, :from_pending => true), class: "btn btn-primary" %>
          <% end %>
        </td>
        <td class="middle-align"></td>
        <td class="middle-align"></td>
    <% else %>
        <td class="middle-align">
          <%= link_to "View Invoice", invoice_payments_path(invoice), class: "btn btn-primary" %>
        </td>
        <td class="middle-align"></td>
        <td class="middle-align"></td>
        <td class="middle-align"></td>
    <% end %>
  <% else %>
      <% if invoice.status == "Started" %>
          <td class="middle-align">
            <%= link_to "View Payments", invoice_payments_path(invoice), class: "btn btn-primary" %>
          </td>
          <td class="middle-align"></td>
          <td class="middle-align"></td>
          <td class="middle-align">
            <%= link_to "Edit", edit_invoice_path(invoice), class: "btn btn-primary" %>
          </td>

          <td class="middle-align">
            <%= link_to "Delete", invoice_path(invoice), class: "btn btn-danger", method: :delete %>
          </td>
      <% elsif invoice.status == "In Progress" %>
          <td class="middle-align">
            <%= link_to "View Payments", invoice_payments_path(invoice), class: "btn btn-primary" %>
          </td>
          <td class="middle-align">
            <% if @user %>
                <%= link_to "Submit", edit_invoice_path(invoice, :submit => true), class: "btn btn-primary" %>
            <% else %>
                <%= link_to "Submit", edit_invoice_path(invoice, :submit => true, :from_pending => true), class: "btn btn-primary" %>
            <% end %>
          </td>
          <td class="middle-align"></td>
          <td class="middle-align">
            <%= link_to "Edit", edit_invoice_path(invoice), class: "btn btn-primary" %>
          </td>

          <td class="middle-align">
            <%= link_to "Delete", invoice_path(invoice), class: "btn btn-danger", method: :delete %>
          </td>
      <% elsif invoice.status == "Pending" %>
          <td class="middle-align">
            <%= link_to "View Invoice", invoice_payments_path(invoice), class: "btn btn-primary" %>
          </td>

          <td class="middle-align">
            <% if @user %>
              <%= link_to "Mark as Paid", edit_invoice_path(invoice, :approve => true), class: "btn btn-success" %>
            <% else %>
              <%= link_to "Mark as Paid", edit_invoice_path(invoice, :approve => true, :from_pending => true), class: "btn btn-success" %>
            <% end %>
          </td>

          <td class="middle-align">
            <% if @user %>
                <%= link_to "Reset", edit_invoice_path(invoice, :reset => true), class: "btn btn-primary" %>
            <% else %>
                <%= link_to "Reset", edit_invoice_path(invoice, :reset => true, :from_pending => true), class: "btn btn-primary" %>
            <% end %>
          </td>

          <td class="middle-align">
            <%= link_to "Edit", edit_invoice_path(invoice), class: "btn btn-primary" %>
          </td>

          <td class="middle-align">
            <%= link_to "Delete", invoice_path(invoice), class: "btn btn-danger", method: :delete %>
          </td>
      <% else %>
          <td class="middle-align">
            <%= link_to "View Invoice", invoice_payments_path(invoice), class: "btn btn-primary" %>
          </td>
          <td class="middle-align"></td>
          <td class="middle-align">
            <% if @user %>
              <%= link_to "Reset", edit_invoice_path(invoice, :reset => true), class: "btn btn-primary" %>
            <% else %>
                <%= link_to "Reset", edit_invoice_path(invoice, :reset => true, :from_pending => true), class: "btn btn-primary" %>
            <% end %>
          </td>

          <td class="middle-align">
            <%= link_to "Edit", edit_invoice_path(invoice), class: "btn btn-primary" %>
          </td>

          <td class="middle-align">
            <%= link_to "Delete", invoice_path(invoice), class: "btn btn-danger", method: :delete %>
          </td>
      <% end %>
  <% end %>
</tr>